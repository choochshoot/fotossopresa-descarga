<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galería de Fotos - Sorpresa de Invitados</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{background:linear-gradient(to bottom,#f8f9fa,#e9ecef);color:#212529;line-height:1.6;overflow-x:hidden;min-height:100vh;}
    header{background:linear-gradient(135deg,#1a1a1a 0%,#000 100%);color:white;text-align:center;padding:1.2rem 0;box-shadow:0 4px 12px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100;}
    .header-content{max-width:1200px;margin:0 auto;padding:0 1rem;}
    h1{font-size:1.5rem;letter-spacing:.5px;margin-bottom:.4rem;font-weight:700;}
    .subtitle{font-size:.85rem;opacity:.85;font-weight:300;max-width:600px;margin:0 auto;}
    .controls{display:flex;justify-content:center;gap:1rem;margin-top:1.2rem;flex-wrap:wrap;}
    .search-container{position:relative;max-width:350px;width:100%;}
    .search-container input{width:100%;padding:.7rem 1rem;padding-left:2.8rem;border-radius:50px;border:1px solid #ddd;font-size:.9rem;background-color:white;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .search-container i{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:#777;font-size:.9rem;}
    .download-btn{background:#ff6b6b;border:none;padding:.7rem 1.2rem;border-radius:50px;color:white;font-size:.9rem;font-weight:600;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.2);transition:all .3s ease;}
    .download-btn:hover{background:#e55353;transform:translateY(-2px);}
    .gallery-container{max-width:1400px;margin:1.2rem auto;padding:0 .8rem;}
    .gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem;}
    .gallery-item{background:white;border-radius:8px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,0.03);display:flex;flex-direction:column;animation:fadeIn .5s ease forwards;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .image-container{position:relative;width:100%;padding-top:100%;overflow:hidden;background:linear-gradient(45deg,#f5f5f5,#eaeaea);}
    .gallery-image{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transition:opacity .5s ease;opacity:0;}
    .gallery-image.loaded{opacity:1;}
    .gallery-info{padding:.7rem;}
    .user-name{font-weight:600;font-size:.9rem;margin-bottom:.3rem;color:#1a1a1a;display:flex;align-items:center;gap:.4rem;}
    .user-name i{color:#777;font-size:.8rem;}
    .message-preview{font-size:.8rem;color:#666;overflow:hidden;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;}
    .stats-container{display:flex;justify-content:center;gap:1.5rem;flex-wrap:wrap;margin-top:.8rem;}
    .stat-card{background:rgba(255,255,255,.15);padding:.6rem 1.2rem;border-radius:50px;display:flex;align-items:center;gap:.6rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .stat-card i{font-size:1rem;color:#ffd43b;}
    .stat-card span{font-weight:500;font-size:.95rem;}
    footer{text-align:center;padding:1.2rem;background:#1a1a1a;color:#ddd;margin-top:2rem;}
    .footer-logo{font-size:1.1rem;font-weight:bold;margin-bottom:.6rem;color:white;}
    .footer-logo span{color:#ff6b6b;}
    .loading{display:none;flex-direction:column;align-items:center;justify-content:center;padding:2rem;}
    .loading i{font-size:2rem;margin-bottom:1rem;color:#666;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .no-results{text-align:center;padding:2rem;display:none;}
    .no-results i{font-size:3rem;margin-bottom:1rem;color:#ccc;}
    @media (min-width:768px){.gallery{grid-template-columns:repeat(3,1fr);}}
    @media (min-width:1024px){.gallery{grid-template-columns:repeat(4,1fr);}}
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <h1>FOTOS PARA SOPRESA PARA INVITADOS</h1>
    <p class="subtitle">Una colección especial de momentos compartidos por nuestros invitados</p>
    <div class="controls">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Buscar por nombre...">
      </div>
      <button id="downloadAllBtn" class="download-btn">
        <i class="fas fa-download"></i> Descargar todas
      </button>
    </div>
    <div class="stats-container">
      <div class="stat-card"><i class="fas fa-images"></i><span>Fotos cargadas: <span id="loadedImages">0</span></span></div>
      <div class="stat-card"><i class="fas fa-database"></i><span>Total fotos compartidas: <span id="totalImages">0</span></span></div>
    </div>
  </div>
</header>

<div class="gallery-container">
  <div id="gallery" class="gallery"></div>
  <div id="loading" class="loading">
    <i class="fas fa-spinner"></i>
    <p>Cargando imágenes...</p>
  </div>
  <div id="noResults" class="no-results">
    <i class="fas fa-image"></i>
    <h3>No se encontraron imágenes</h3>
    <p>Intenta con otros términos de búsqueda</p>
  </div>
</div>

<footer>
  <div class="footer-content">
    <div class="footer-logo">Sorpresa<span>Invitados</span></div>
    <p>Comparte momentos especiales con tus seres queridos</p>
    <p class="copyright">© 2023 Galería de Sorpresas. Todos los derechos reservados.</p>
  </div>
</footer>

<script>
  // Configuración de Supabase
  const SUPABASE_URL = 'https://cskqlyauszpgjvwgenth.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNza3FseWF1c3pwZ2p2d2dlbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MTY4ODMsImV4cCI6MjA3MDE5Mjg4M30.HAZEfpAH2AZzoDBmsUOe3O33oAFbcRIJksZLOyeRvPk';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const BUCKET_NAME = 'imagenes-usuarios';

  // Elementos del DOM
  const gallery = document.getElementById('gallery');
  const loading = document.getElementById('loading');
  const searchInput = document.getElementById('searchInput');
  const loadedImages = document.getElementById('loadedImages');
  const totalImages = document.getElementById('totalImages');
  const noResults = document.getElementById('noResults');
  const downloadAllBtn = document.getElementById('downloadAllBtn');

  // Variables de estado
  let currentPage = 1;
  const itemsPerPage = 16;
  let isLoading = false;
  let allDataLoaded = false;
  let imagesData = [];
  let totalImagesCount = 0;
  let searchTerm = '';
  let debounceTimer;

  // Inicialización
  async function init() {
    await getTotalImagesCount();
    await loadImages();
    setupEventListeners();
  }

  // Obtener el conteo total de imágenes
  async function getTotalImagesCount() {
    try {
      const { count, error } = await supabase
        .from('mensajes')
        .select('*', { count: 'exact', head: true });
      
      if (error) throw error;
      totalImagesCount = count;
      totalImages.textContent = count;
    } catch (error) {
      console.error('Error al obtener el conteo total:', error);
    }
  }

  // Cargar imágenes desde Supabase
  async function loadImages() {
    if (isLoading || allDataLoaded) return;
    
    isLoading = true;
    loading.style.display = 'flex';
    noResults.style.display = 'none';

    try {
      let query = supabase
        .from('mensajes')
        .select('nombre, mensaje, imagen_url, created_at')
        .order('created_at', { ascending: false })
        .range((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage - 1);

      if (searchTerm) {
        query = query.ilike('nombre', `%${searchTerm}%`);
      }

      const { data, error } = await query;
      
      if (error) throw error;

      if (!data || data.length === 0) {
        if (currentPage === 1) {
          noResults.style.display = 'block';
          gallery.innerHTML = '';
        }
        allDataLoaded = true;
        return;
      }

      // Procesar y mostrar imágenes
      await processAndDisplayImages(data);
      
      currentPage++;
      loadedImages.textContent = imagesData.length;
      
    } catch (error) {
      console.error('Error al cargar imágenes:', error);
    } finally {
      isLoading = false;
      loading.style.display = 'none';
    }
  }

  // Procesar y mostrar imágenes
  async function processAndDisplayImages(data) {
    for (const item of data) {
      if (!imagesData.some(img => img.imagen_url === item.imagen_url)) {
        imagesData.push(item);
        
        try {
          // Obtener URL pública de la imagen desde Supabase Storage
          const { data: { publicUrl } } = supabase
            .storage
            .from(BUCKET_NAME)
            .getPublicUrl(item.imagen_url);
          
          item.publicUrl = publicUrl;
          createGalleryItem(item);
        } catch (error) {
          console.error('Error al obtener URL pública:', error);
          // Si falla, usar la URL original
          item.publicUrl = item.imagen_url;
          createGalleryItem(item);
        }
      }
    }
  }

  // Crear elemento de galería
  function createGalleryItem(item) {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'image-container';
    
    const img = document.createElement('img');
    img.className = 'gallery-image';
    img.alt = `Imagen de ${item.nombre || 'Anónimo'}`;
    
    // Cargar imagen con manejo de errores
    loadImageWithFallback(img, item.publicUrl);
    
    const info = document.createElement('div');
    info.className = 'gallery-info';
    info.innerHTML = `
      <div class="user-name"><i class="fas fa-user"></i>${item.nombre || 'Anónimo'}</div>
      <div class="message-preview">${item.mensaje || ''}</div>
    `;
    
    imageContainer.appendChild(img);
    div.appendChild(imageContainer);
    div.appendChild(info);
    gallery.appendChild(div);
  }

  // Cargar imagen con manejo de errores
  function loadImageWithFallback(imgElement, url) {
    imgElement.onload = function() {
      this.classList.add('loaded');
    };
    
    imgElement.onerror = function() {
      // Si falla la carga, intentar con la URL original
      if (url !== this.src) {
        this.src = url;
      } else {
        console.error('Error al cargar la imagen:', url);
        this.alt = 'Error al cargar la imagen';
      }
    };
    
    imgElement.src = url;
  }

  // Configurar event listeners
  function setupEventListeners() {
    // Búsqueda con debounce
    searchInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        searchTerm = this.value.trim();
        resetAndLoadImages();
      }, 500);
    });

    // Descargar todas las imágenes
    downloadAllBtn.addEventListener('click', downloadAllImages);

    // Paginación infinita
    window.addEventListener('scroll', throttle(() => {
      const scrollPosition = window.scrollY + window.innerHeight;
      const pageHeight = document.documentElement.scrollHeight - 100;
      
      if (scrollPosition >= pageHeight && !isLoading && !allDataLoaded) {
        loadImages();
      }
    }, 500));
  }

  // Reiniciar y cargar imágenes (para búsquedas)
  function resetAndLoadImages() {
    currentPage = 1;
    imagesData = [];
    allDataLoaded = false;
    gallery.innerHTML = '';
    loadImages();
  }

  // Función throttle para scroll
  function throttle(callback, delay) {
    let lastCall = 0;
    return function() {
      const now = new Date().getTime();
      if (now - lastCall >= delay) {
        lastCall = now;
        callback.apply(this, arguments);
      }
    };
  }

  // Verificar si es HEIC
  function isHeic(url) {
    return url.toLowerCase().endsWith('.heic');
  }

  // Convertir HEIC a JPEG
  async function convertHeicToJpeg(heicUrl) {
    try {
      const response = await fetch(heicUrl);
      const blob = await response.blob();
      const jpegBlob = await heic2any({ blob: blob, toType: 'image/jpeg', quality: 0.8 });
      return URL.createObjectURL(jpegBlob);
    } catch (e) {
      console.error('Error convirtiendo HEIC a JPEG:', e);
      return heicUrl;
    }
  }

  // Convertir a PNG
  async function convertToPng(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext("2d").drawImage(img, 0, 0);
        canvas.toBlob(blob => resolve(blob), "image/png");
      };
      img.onerror = () => reject("Error al cargar la imagen");
      img.src = url;
    });
  }

  // Descargar blob
  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Descargar todas las imágenes
  async function downloadAllImages() {
    if (imagesData.length === 0) {
      alert("No hay imágenes cargadas.");
      return;
    }

    downloadAllBtn.disabled = true;
    downloadAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Descargando...';

    const nameCount = {};
    
    for (const [index, item] of imagesData.entries()) {
      try {
        let imageUrl = item.publicUrl || item.imagen_url;
        
        // Si es HEIC, convertir primero
        if (isHeic(imageUrl)) {
          imageUrl = await convertHeicToJpeg(imageUrl);
        }
        
        const pngBlob = await convertToPng(imageUrl);
        let safeName = (item.nombre || "Anonimo").replace(/[^a-z0-9]/gi, "_");
        nameCount[safeName] = (nameCount[safeName] || 0) + 1;
        const filename = `${safeName}_${nameCount[safeName]}.png`;
        
        downloadBlob(pngBlob, filename);
        
        // Pequeña pausa entre descargas para evitar bloqueos del navegador
        await new Promise(r => setTimeout(r, 300));
        
        // Actualizar texto del botón con progreso
        if (imagesData.length > 1) {
          const progress = Math.round(((index + 1) / imagesData.length) * 100);
          downloadAllBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Descargando (${progress}%)`;
        }
      } catch (e) {
        console.error("Error descargando imagen:", e);
      }
    }
    
    downloadAllBtn.disabled = false;
    downloadAllBtn.innerHTML = '<i class="fas fa-download"></i> Descargar todas';
    alert("Descarga completada.");
  }

  // Iniciar la aplicación
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
